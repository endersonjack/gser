{% extends "mobile_menu_base.html" %}
{% load static %}

{% block title %}Buscar OS e Serviços{% endblock %}

{% block extra_head %}
  {# Select2 CSS #}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Deixa o Select2 com altura compacta para alinhar com botão btn-sm */
    .select2-container .select2-selection--single {
      height: calc(1.8125rem + 2px); /* altura aproximada do .form-select.form-select-sm */
      padding: 2px 6px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 1.4rem;
      padding-left: 0;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 100%;
      right: 6px;
    }
    .col-qtd {
  max-width: 80px;       /* largura máxima da célula */
  white-space: nowrap;   /* impede quebra de linha */
  overflow: hidden;      /* esconde o excesso */
  text-overflow: ellipsis; /* adiciona "..." no final */
}

  </style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Cabeçalho com botões -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h4 class="mb-0"><i class="fa fa-search me-2"></i> Busca Avançada</h4>

      <a href="{% url 'buscar_os' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fa fa-times"></i> Limpar Todos os Campos
      </a>

      {% if filtros.tipo and tem_resultados %}
        <a id="exportarPdfBtn" href="{% url 'exportar_resultado_pdf' %}?{{ request.GET.urlencode }}"
           class="btn btn-outline-danger btn-sm" target="_blank" rel="noopener">
          <i class="fa fa-file-pdf"></i> Exportar PDF
        </a>
      {% endif %}
    </div>

    <a href="{% url 'contratos' %}" class="btn btn-outline-secondary d-none d-md-inline-block">
      <i class="fa fa-arrow-left"></i> Voltar aos Contratos
    </a>
  </div>

  <div class="accordion" id="accordionBusca">

    <!-- Buscar OS -->
    <div class="accordion-item mb-3">
      <h2 class="accordion-header" id="headingOs">
        <button class="accordion-button {% if not filtros.tipo or filtros.tipo == 'os' %} {% else %}collapsed{% endif %}"
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseOs"
                aria-expanded="true" aria-controls="collapseOs">
          <i class="fa fa-file-alt me-2 text-primary"></i> Buscar Ordem de Serviço
        </button>
      </h2>
      <div id="collapseOs" class="accordion-collapse collapse {% if not filtros.tipo or filtros.tipo == 'os' %}show{% endif %}"
           aria-labelledby="headingOs" data-bs-parent="#accordionBusca">
        <div class="accordion-body">

          <form method="get" class="mb-4" id="formBuscaOS">
            <input type="hidden" name="tipo" value="os">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label class="form-label">Contrato</label>
                <select name="contrato" class="form-select form-select-sm">
                  <option value="">Todos</option>
                  {% for contrato in contratos %}
                    <option value="{{ contrato.id }}" {% if filtros.contrato == contrato.id|stringformat:"s" %}selected{% endif %}>
                      {{ contrato.numero }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-2">
                <label class="form-label">Nº OS</label>
                <input type="text" name="numero_os" class="form-control form-control-sm" value="{{ filtros.numero_os }}">
              </div>

              <div class="col-md-3">
                <label class="form-label">Situação da OS</label>
                <select name="situacao" class="form-select form-select-sm">
                  <option value="">Todas</option>
                  {% for key, label in situacao_choices %}
                    <option value="{{ key }}" {% if filtros.situacao == key %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Localidade</label>
                <select name="local" class="form-select form-select-sm js-local-select" data-placeholder="Pesquisar local...">
                  <option value="">Todas as Localidades</option>
                  {% for local in locais %}
                    <option value="{{ local.id }}" {% if filtros.local == local.id|stringformat:"s" %}selected{% endif %}>
                      {{ local.nome }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-1 d-grid">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </div>
          </form>

          {% if filtros.tipo == 'os' and resultados_os %}
            <p class="text-muted small">Total: {{ resultados_os|length }} ordens encontradas</p>
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">#</th>
                    <th class="text-center">Nº OS</th>
                    <th>Contrato</th>
                    <th>Local</th>
                    <th class="text-center">Início</th>
                    <th class="text-center">Situação</th>
                  </tr>
                </thead>
                <tbody>
                  {% for os in resultados_os %}
                    <tr class="clickable-row" data-href="{% url 'ver_ordem_servico' os.id %}" style="cursor: pointer;">
                      <td class="text-center">{{ forloop.counter }}</td>
                      <td class="text-center">{{ os.numero_formatado }} {% if os.urgente %}
                       <span id="badge-urgente" class="badge rounded-pill" style="background:#dc3545;color:#fff;">
                        <i class="fa fa-bolt me-1"></i> URGENTE
                      </span>  
                      {% endif %}</td>
                      <td>{{ os.contrato.numero }}</td>
                      <td>{{ os.local.nome }}</td>
                      <td class="text-center">{{ os.data_inicio|date:"d/m/Y" }}</td>
                      <td class="text-center">{{ os.get_situacao_display }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% elif filtros.tipo == 'os' %}
            <div class="alert alert-warning">Nenhuma OS encontrada.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Buscar Serviço -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingServico">
        <button class="accordion-button {% if filtros.tipo == 'servico' %} {% else %}collapsed{% endif %}"
                type="button" data-bs-toggle="collapse" data-bs-target="#collapseServico"
                aria-expanded="false" aria-controls="collapseServico">
          <i class="fa fa-tools me-2 text-success"></i> Buscar Serviço
        </button>
      </h2>
      <div id="collapseServico" class="accordion-collapse collapse {% if filtros.tipo == 'servico' %}show{% endif %}"
           aria-labelledby="headingServico" data-bs-parent="#accordionBusca">
        <div class="accordion-body">

        <form method="get" class="mb-4" id="formBuscaServico">
  <input type="hidden" name="tipo" value="servico">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Descrição</label>
      <input type="text" name="descricao" class="form-control form-control-sm" value="{{ filtros.descricao }}">
    </div>

    <div class="col-md-2">
      <label class="form-label">Categoria</label>
      <select name="categoria" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for categoria in categorias %}
          <option value="{{ categoria.id }}" {% if filtros.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>
            {{ categoria.nome }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Situação</label>
      <select name="situacao_servico" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for key, label in situacao_choices %}
          <option value="{{ key }}" {% if filtros.situacao_servico == key %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Localidade</label>
      <select name="local" class="form-select form-select-sm js-local-select" data-placeholder="Pesquisar local...">
        <option value="">Todas as Localidades</option>
        {% for local in locais %}
          <option value="{{ local.id }}" {% if filtros.local == local.id|stringformat:"s" %}selected{% endif %}>
            {{ local.nome }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Início (de)</label>
      <input type="date" name="data_inicio" class="form-control form-control-sm" value="{{ filtros.data_inicio }}">
    </div>

    <div class="col-md-2">
      <label class="form-label">Início (até)</label>
      <input type="date" name="data_fim" class="form-control form-control-sm" value="{{ filtros.data_fim }}">
    </div>

    <div class="col-md-1 d-grid">
      <button type="submit" class="btn btn-success btn-sm">
        <i class="fa fa-search"></i>
      </button>
    </div>
  </div>
</form>


          {% if filtros.tipo == 'servico' and resultados_servico %}
            <p class="text-muted small">Total: {{ resultados_servico|length }} serviços encontrados</p>
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Situação</th>
                    <th class="col-qtd text-center">Qtd</th>
                    <th>Nº OS</th>
                  </tr>
                </thead>
                <tbody>
                  {% for servico in resultados_servico %}
                    <tr class="clickable-row" data-href="{% url 'visualizar_servico' servico.ordem.id servico.id %}" style="cursor: pointer;">
                      <td>{{ forloop.counter }}</td>
                      <td>{{ servico.descricao|truncatechars:60 }}</td>
                      <td>{{ servico.categoria.nome }}</td>
                      <td>{{ servico.get_situacao_display }} {% if servico.urgente %}
                       <span id="badge-urgente" class="badge rounded-pill" style="background:#dc3545;color:#fff;">
                        <i class="fa fa-bolt me-1"></i> URGENTE
                      </span>  
                      {% endif %}</td>
                      <td class="col-qtd text-center" title="{{ servico.quantidade }}">{{ servico.quantidade }}</td>
                      <td>{{ servico.ordem.numero_formatado }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% elif filtros.tipo == 'servico' %}
            <div class="alert alert-warning">Nenhum serviço encontrado.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JS -->
{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  {# Select2 JS + i18n pt-BR #}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt-BR.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // clique na linha
      document.querySelectorAll('.clickable-row').forEach(function (row) {
        row.addEventListener('click', function () {
          window.location.href = row.dataset.href;
        });
      });

      // comportamento Exportar PDF (download no mobile / nova aba no desktop)
      const link = document.getElementById('exportarPdfBtn');
      if (link) {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          link.removeAttribute('target');
          link.setAttribute('download', 'relatorio_busca.pdf');
        } else {
          link.setAttribute('target', '_blank');
          link.removeAttribute('download');
        }
      }

      // inicializa Select2 nos campos de Localidade (ambas as abas)
      function initSelect2() {
        $('.js-local-select').select2({
          width: '100%',
          placeholder: function() {
            return $(this).data('placeholder') || 'Pesquisar...';
          },
          allowClear: true,
          language: 'pt-BR'
        });
      }

      // garante que o Select2 esteja certo ao abrir/fechar o accordion
      initSelect2();
      document.querySelectorAll('#accordionBusca .accordion-button').forEach(btn => {
        btn.addEventListener('click', () => {
          setTimeout(() => {
            initSelect2();
          }, 200);
        });
      });
    });
  </script>
{% endblock %}
{% endblock %}
