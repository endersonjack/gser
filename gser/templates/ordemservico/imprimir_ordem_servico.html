{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Imprimir Ordem de Serviço</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <style>
    /* Margens menores e otimização para impressão */
    @page {
    size: A4;
    margin: 5mm; /* margem mínima */
  }
  body {
    font-size: 13px;
    line-height: 1.3;
  }
  @media print {
    .no-print, .no-print * {
      display: none !important;
      visibility: hidden !important;
    }
    body {
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 100%;
      padding: 20px;
    }
    .card-impressao, .titulo-secao, .quadro-ocorrencias, .assinaturas, .linha-assinatura {
      page-break-inside: avoid;
    }


      table, img, p, div {
        page-break-inside: avoid !important;
      }
    }

    .quadro-ocorrencias {
      border: 1px dashed #000;
      height: 160px;
      padding: 8px;
      margin-bottom: 15px;
    }
    .assinaturas {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }
    .assinatura-bloco {
      width: 45%;
      text-align: center;
    }
    .linha-assinatura {
      border-top: 1px solid #000;
      margin-top: 50px;
    }
    .logo { max-height: 70px; }
    .card-impressao { border: 1px solid #000; padding: 15px; }
    .form-check { margin-bottom: 6px; }
    .foto-preview {
      max-height: 90px;
      margin: 4px;
      border: 1px solid #ddd;
    }
    .titulo-secao {
      background: #f0f0f0;
      padding: 4px 8px;
      font-weight: bold;
      border: 1px solid #ccc;
      margin-top: 15px;
    }
  </style>
</head>
<body class="container my-3">

  <!-- Botões topo -->
  <div class="d-flex justify-content-end gap-2 mb-2 no-print">
    <a href="{% url 'ver_ordem_servico' ordem.id %}" class="btn btn-outline-secondary">
      <i class="fa fa-arrow-left"></i> Voltar para a OS
    </a>
    <button class="btn btn-primary" onclick="window.print()">
      <i class="fa fa-print"></i> Imprimir
    </button>
    <a href="{% url 'imprimir_ordem_servico_pdf' ordem.id %}" class="btn btn-danger" target="_blank" rel="noopener">
      <i class="fa fa-file-pdf"></i> Gerar PDF
    </a>
  </div>

  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      {% if empresa and empresa.logo %}
        <img src="{{ empresa.logo.url }}" alt="Logo" class="logo">
      {% else %}
        <span class="text-muted small">[Sem logo]</span>
      {% endif %}
      <div>
        <h5 class="mb-0">Ordem de Serviço</h5>
        <small><strong>Empresa:</strong> {{ empresa.nome|default:"-" }}</small><br>
        {% if empresa.endereco %}<small><strong>Endereço:</strong> {{ empresa.endereco }}</small><br>{% endif %}
        {% if empresa.telefone %}<small><strong>Telefone:</strong> {{ empresa.telefone }}</small><br>{% endif %}
      </div>
    </div>
    <div class="text-end">
      <small><strong>Órgão:</strong> {{ ordem.contrato.orgao_contratante }}</small><br>
      <small><strong>Contrato:</strong> {{ ordem.contrato.numero }}</small>
    </div>
  </div>

  <!-- Dados da OS -->
  <div class="card-impressao mb-2">
    <div class="row">
      <div class="col-md-4"><strong>Nº OS:</strong> {{ ordem.numero_formatado }}</div>
      <div class="col-md-8"><strong>Local:</strong> {{ ordem.local.nome }}</div>
      <div class="col-md-12"><strong>Endereço:</strong> {{ ordem.local.endereco }}</div>
      <div class="col-md-6"><strong>Data de Início:</strong> {{ ordem.data_inicio|date:"d/m/Y" }}</div>
      {% if ordem.data_termino %}
      <div class="col-md-6"><strong>Data de Término:</strong> {{ ordem.data_termino|date:"d/m/Y" }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Serviços -->
  <div>
    <div class="titulo-secao">Serviços Selecionados</div>
    {% for servico in ordem.servicos.all %}
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="servico{{ servico.id }}">
        <label class="form-check-label" for="servico{{ servico.id }}">
          {{ servico.descricao }} ({{ servico.categoria.nome }})
        </label>
      </div>
      {% for album in servico.albuns.all %}
        <div class="ms-4 form-check">
          <input class="form-check-input" type="checkbox" id="album{{ album.id }}">
          <label class="form-check-label" for="album{{ album.id }}">
            Álbum: {{ album.nome }}
          </label>
          <div class="d-flex flex-wrap">
            {% for foto in album.fotos.all|slice:":3" %}
              <img src="{{ foto.imagem.url }}" alt="Foto" class="foto-preview">
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- Observações -->
  {% if ordem.observacao %}
    <div class="titulo-secao">Observações</div>
    <div class="card card-body mb-3">{{ ordem.observacao }}</div>
  {% endif %}

  <!-- Ocorrências -->
  <div class="titulo-secao">Ocorrências</div>
  <div class="quadro-ocorrencias"></div>

  <!-- Local e Data -->
  <div class="text-end mb-3">
    <strong>Local e Data:</strong> ____________________________________, {{ hoje|date:"d/m/Y" }}
  </div>

  <!-- Assinaturas -->
<div class="text-center assinaturas">
  <div class="assinatura-bloco">
    <div class="linha-assinatura"></div>
    <small>Assinatura da {{ empresa.nome|default:"-" }}</small>
  </div>
  <div class="assinatura-bloco">
    <div class="linha-assinatura"></div>
    <small>Assinatura do Funcionário</small>
  </div>
</div>

<!-- Direção centralizada -->
<div class="assinaturas mt-4" style="justify-content: center;">
  <div class="assinatura-bloco" style="width: 45%; text-align: center;">
    <p class="mb-0">Serviço finalizado em: _____ / _____ / _____</p>
    <div class="linha-assinatura"></div>
    <small>Assinatura da Direção / Responsável</small>
  </div>
</div>


</body>
</html>
