{% extends "mobile_menu_base.html" %}
{% load static %}

{% block title %}Editar Ordem de Serviço — OS {{ ordem.numero }}{% endblock %}

{% block extra_head %}
<style>
  /* Evitar overflow lateral */
  .wrapper{ overflow-x:hidden; }
  .main-content{ flex:1; min-width:0; overflow-x:hidden; padding:20px; }

  /* Garantir que nada “estoure” a largura */
  .container, .container-fluid, .card, .card-body { max-width:100%; overflow-x:hidden; }
  img, table { max-width:100%; height:auto; }

  .page-title { font-weight: 700; }
  .muted-line { font-size: .9rem; color: #6c757d; }
  .field-group { margin-bottom: .75rem; }
  .field-group .form-label { font-weight: 600; font-size: .9rem; margin-bottom: .3rem; }
</style>
{% endblock %}

{% block voltar_botao %}
  <a href="{% url 'ver_ordem_servico' ordem.id %}"
     class="d-none d-md-block py-2 px-3 text-white text-decoration-none"
     title="Voltar à OS {{ ordem.numero }}">
    <i class="fa fa-arrow-left me-2"></i> Voltar
  </a>
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="container py-4">

    <!-- Cabeçalho -->
    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h4 class="mb-0 page-title">
          <i class="fa fa-plus-circle me-2"></i> Adicionar Serviço à OS #{{ ordem.numero }}
        </h4>
        <!-- Voltar (mobile) -->
        <a href="{% url 'ver_ordem_servico' ordem.id %}" class="btn btn-outline-secondary d-md-none">
          <i class="fa fa-arrow-left"></i> Voltar
        </a>
      </div>

      <!-- Local e Contrato -->
      <div class="text-muted small mt-1 d-flex flex-wrap gap-3">
        <span>Local: {{ ordem.local.nome }}</span>
        <span>Contrato: {{ ordem.contrato.numero }}</span>
      </div>
    </div>

    <!-- Formulário -->
    <form method="post" class="card card-body shadow-sm">
      {% csrf_token %}
      {{ formset.management_form }}

       
      {% with f=formset.forms.0|default:formset.empty_form %}

        
        {% if formset.non_form_errors %}
          <div class="alert alert-danger mb-3">{{ formset.non_form_errors }}</div>
        {% endif %}

        <div class="row g-3">

 
  {% if f.descricao %}
    <div class="col-12">
      <label class="form-label" for="{{ f.descricao.id_for_label }}">{{ f.descricao.label }}</label>
      <textarea name="{{ f.descricao.html_name }}" id="{{ f.descricao.id_for_label }}" rows="3" class="form-control">{% if f.descricao.value %}{{ f.descricao.value }}{% endif %}</textarea>
      {% if f.descricao.errors %}<div class="text-danger small mt-1">{{ f.descricao.errors }}</div>{% endif %}
    </div>
  {% endif %}

   
  <div class="col-12 col-md-6">
    {% if f.situacao %}
      <label class="form-label" for="{{ f.situacao.id_for_label }}">{{ f.situacao.label }}</label>
      {{ f.situacao }}
      {% if f.situacao.errors %}<div class="text-danger small mt-1">{{ f.situacao.errors }}</div>{% endif %}
    {% endif %}
  </div>
  <div class="col-12 col-md-6">
    {% if f.quantidade %}
      <label class="form-label" for="{{ f.quantidade.id_for_label }}">{{ f.quantidade.label }}</label>
      <input type="text" name="{{ f.quantidade.html_name }}" id="{{ f.quantidade.id_for_label }}" 
             class="form-control" value="{{ f.quantidade.value|default_if_none:'' }}">
      {% if f.quantidade.errors %}<div class="text-danger small mt-1">{{ f.quantidade.errors }}</div>{% endif %}
    {% endif %}
  </div>

   
  {% for field in f.visible_fields %}
    {% if field.name == 'data_finalizacao' %}
      <div class="col-12 col-md-6" id="data_finalizacao_div" style="display:none;">
        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors }}</div>{% endif %}
      </div>
    {% elif field.name not in 'descricao observacao quantidade situacao' %}
      <div class="col-12 col-md-6">
        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors }}</div>{% endif %}
      </div>
    {% endif %}
  {% endfor %}

  
  {% if f.observacao %}
    <div class="col-12">
      <label class="form-label" for="{{ f.observacao.id_for_label }}">{{ f.observacao.label }}</label>
      <input type="text" name="{{ f.observacao.html_name }}" id="{{ f.observacao.id_for_label }}" 
             class="form-control" value="{{ f.observacao.value|default_if_none:'' }}">
      {% if f.observacao.errors %}<div class="text-danger small mt-1">{{ f.observacao.errors }}</div>{% endif %}
    </div>
  {% endif %}

</div>

      {% endwith %}

      <div class="mt-4 d-flex flex-column flex-md-row justify-content-end gap-2">
        <button type="submit" name="encerrar" class="btn btn-success">
          <i class="fa fa-check"></i> Salvar e Encerrar
        </button>
        <button type="submit" name="continuar" class="btn btn-primary">
          <i class="fa fa-plus"></i> Salvar e Adicionar + Serviço
        </button>
      </div>
    </form>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% with f=formset.forms.0|default:formset.empty_form %}
<script>
  document.addEventListener("DOMContentLoaded", function(){
    // evita overflow de algum componente fora do BootStrap
    document.body.style.overflowX = "hidden";

    const situacao = document.getElementById("{{ f.situacao.id_for_label }}");
    const dataFinalizacaoDiv = document.getElementById("data_finalizacao_div");
    const dataFinalizacaoInput = document.getElementById("{{ f.data_finalizacao.id_for_label }}");

    function toggleDataFinalizacao() {
      if (situacao.value === 'finalizado') {
        dataFinalizacaoDiv.style.display = 'block';
        if (dataFinalizacaoInput) dataFinalizacaoInput.required = true;
      } else {
        dataFinalizacaoDiv.style.display = 'none';
        if (dataFinalizacaoInput) {
          dataFinalizacaoInput.required = false;
          dataFinalizacaoInput.value = '';
        }
      }
    }

    if (situacao && dataFinalizacaoDiv) {
      situacao.addEventListener('change', toggleDataFinalizacao);
      toggleDataFinalizacao();
    }
  });
</script>
{% endwith %}
{% endblock %}
