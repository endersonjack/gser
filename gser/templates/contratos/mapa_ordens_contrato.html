{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  <meta name="theme-color" content="#0d6efd" />
  <title>Mapa de Ordens - Contrato {{ contrato.numero }}</title>



  <!-- Estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css" />

<!-- CSS (AwesomeMarkers) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.css" />




  <style>
    body {
      padding-bottom: 70px;
    }
    .sidebar {
      width: 260px;
      background-color: #343a40;
      color: #fff;
      padding: 20px 15px;
      flex-shrink: 0;
    }
    .sidebar a {
      display: block;
      color: #fff;
      padding: 10px 15px;
      text-decoration: none;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background-color: #007bff;
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: 10px;
    }
    @media (max-width: 768px) {
      .sidebar {
        display: none !important;
      }
      .main-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

<div class="d-flex flex-column flex-md-row">

  <!-- Sidebar -->
  <div class="sidebar d-none d-md-block">
    <a href="{% url 'dashboard_contrato' contrato.id %}"><i class="fa fa-arrow-left me-2"></i> Voltar ao Painel</a>
    <a href="{% url 'criar_ordem_servico' %}" class="btn btn-success w-100 mb-3">
      <i class="fa fa-plus-circle me-2"></i> Nova O.S.
    </a>
    <a href="{% url 'buscar_os' %}" class="d-block text-white text-decoration-none">
      <i class="fa fa-search me-2"></i> Buscar
    </a>
  </div>

  <!-- Conteúdo -->
  <div class="main-content flex-grow-1 p-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
      <div>
        <h4 class="mb-1"><i class="fa fa-map-marked-alt me-2"></i> Mapa de Ordens</h4>
        <p class="text-muted mb-0 small">
          <strong>Contrato:</strong> {{ contrato.numero }}<br>
          <strong>Empresa:</strong> {{ contrato.empresa_contratada }} |
          <strong>Órgão:</strong> {{ contrato.orgao_contratante }}
        </p>
      </div>
      <a href="{% url 'dashboard_contrato' contrato.id %}" class="btn btn-outline-secondary d-none d-md-inline">
        <i class="fa fa-arrow-left"></i> Voltar ao Painel
      </a>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<!-- Leaflet core -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JS (AwesomeMarkers) -->
<script src="https://unpkg.com/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.js"></script>

<!-- Leaflet Awesome Markers -->
<script src="https://unpkg.com/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.js"></script>

<script>
  window.addEventListener("load", function () {
    const map = L.map('map').setView([-5.8, -35.2], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marcadores = {{ marcadores|safe }};
    const markerList = [];
    const posicoesUsadas = {};

    marcadores.forEach(item => {
      let lat = parseFloat(item.lat);
      let lng = parseFloat(item.lng);
      const chave = `${Math.floor(lat * 10000)},${Math.floor(lng * 10000)}`;

      if (posicoesUsadas[chave]) {
        const count = posicoesUsadas[chave];
        lat += 0.00015 * count;
        lng += 0.00015 * count;
        posicoesUsadas[chave] += 1;
      } else {
        posicoesUsadas[chave] = 1;
      }

      let cor = "blue";
      const status = item.situacao.toLowerCase();
      if (status.includes("não iniciado")) cor = "gray";
      else if (status.includes("andamento")) cor = "blue";
      else if (status.includes("pendente") || status.includes("paralisado")) cor = "orange";
      else if (status.includes("cancelado")) cor = "red";
      else if (status.includes("finalizado")) cor = "green";

      const icon = L.AwesomeMarkers.icon({
        icon: 'wrench',
        markerColor: cor,
        prefix: 'fa'
      });

      const marker = L.marker([lat, lng], { icon }).addTo(map);
      marker.bindPopup(`
        <strong><a href="${item.url}" class="text-decoration-none">${item.local_nome}</a></strong><br/>
        <a href="${item.url}" class="text-primary text-decoration-none">O.S. Nº <strong>${item.numero}</strong></a><br/>
        Situação: ${item.situacao}
      `);
      markerList.push(marker);
    });

    if (markerList.length > 0) {
      const group = L.featureGroup(markerList);
      map.fitBounds(group.getBounds().pad(0.1));
    }
  });
</script>





</body>
</html>
